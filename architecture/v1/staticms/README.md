# Staticms

**Staticms** は、GitHubの自分のリポジトリをストレージとするヘッドレスCMSです。
[Deno](https://deno.land/)と[React](https://react.dev/)で構築されており、GitHub
Appとして動作することで、リポジトリ内のMarkdownやYAMLファイルを直感的なUIで編集・管理できます。

## 特徴

- **GitHub完全統合**:
  データはすべてGitHubリポジトリに保存されます。データベースは不要です。
- **リアルタイム更新**:
  Webhookを利用し、GitHub上での変更が即座にエディタに反映されます。
- **Pull Requestベース**: 変更はPull
  Requestとして作成されるため、レビュープロセスに自然に組み込めます。
- **柔軟な設定**:
  フロントマターのスキーマを自由に定義でき、様々な静的サイトジェネレーター（Hugo,
  Jekyll, Next.jsなど。そして[Lume](https://lume.land/)！）に対応可能です。
- **GitHub App認証**: セキュアな認証と、細かい権限管理が可能です。
- **ローカル下書き保存**:
  編集中の内容はブラウザのローカルストレージに自動保存され、誤ってタブを閉じても作業を再開できます。
- **コミット履歴**:
  ファイルの変更履歴（コミットログ）をエディタ内で確認できます。
- **GitHub風のUI**:
  GitHubのUIを模して、直感的な操作が可能です。デザインは似た感じの[Semantic-UI](https://semantic-ui.com/)を利用しています。

## 詳細な操作手順

### 1. 利用開始（ログインとリポジトリ選択）

1. Staticmsのトップページにアクセスします。未ログインの場合は自動的にGitHubの認証画面へリダイレクトされます。
2. 認証が完了すると、Staticms GitHub
   Appがインストールされているリポジリの一覧が表示されます。管理したいリポジリをクリックして選択してください。

### 2. コンテンツ設定の追加 (Content Configuration)

初めてリポジリを開いた場合、または新しいコンテンツタイプを追加する場合は、設定画面から構成を定義します。

1. リポジリトップ画面の **Add Content Config** または既存設定の **Edit**
   ボタン（歯車アイコン）をクリックします。
2. **Configuration** 画面で以下の項目を入力します：
   - **Display Name**: 管理画面で表示される名前（例: "Articles",
     "Authors"など）。
   - **Type**:
     - **Singleton (File)**: 単一のファイルを管理する場合（例: サイト設定）。
     - **Collection (Files)**: 複数のMarkdownファイルを管理する場合（例:
       ブログ記事）。
   - **Content Binding**:
     - **File**:
       特定のファイル、またはディレクトリ配下のファイルを直接指定します。
     - **Directory**: ディレクトリを指定し、その配下の `index.md`
       を編集対象とします（ブログなど）。
   - **File Path**: コンテンツが格納されているリポジトリ内のパス（例: `posts`
     または
     `data/authors.yaml`）。BindingでDirectoryを選択した場合はフォルダパスを入力します。そのフォルダ内の
     `index.md` が自動的に編集対象となります。
   - **Fields**: フロントマター（メタデータ）の定義を追加します（Title, Date,
     Tagsなど）。各フィールドの型（String, Number, Date,
     Listなど）を指定できます。
   - **Archetype** (Collectionのみ):
     新規記事作成時にデフォルトで挿入されるMarkdownのテンプレートを設定できます。
3. **Save Configuration**
   をクリックして設定を保存します。設定はリポジトリのKVストレージに保存されます。

### 3. コンテンツの作成・編集

#### 記事一覧画面

設定したコンテンツタイプが **Collection**
の場合、ファイル一覧が表示されます（**Singleton**
の場合は直接エディタが開きます）。

- **新規作成**: 右上の「＋」ボタンをクリックして新しい記事を作成します。
- **編集**: リストからファイルをクリックして編集画面へ進みます。
- **削除**:
  ゴミ箱アイコンをクリックして削除します（※PRを作成して削除を提案します）。

#### エディタ画面

エディタは左右（スマホでは上下）の2ペイン構成です。

- **左ペイン（エディタ）**:
  - **Front Matter**: 設定で定義したフィールドを入力します。
    - **YAMLリスト編集**:
      ルートが配列のYAMLファイル（Singleton）を開いた場合は、アイテムを追加・削除できるリストエディタが表示されます。1つのファイル内に複数のデータ定義を列挙する場合に使用します。
  - **Markdown Body**:
    本文をMarkdown形式で記述します。リアルタイムプレビューが可能です。[react-md-editor](https://github.com/uiwjs/react-md-editor)を利用しています。
- **右ペイン（情報・ツール）**:
  - **Draft / PR Status**: プルリクエストの作成やステータス確認ができます。
  - **Images Nearby**:
    編集中の記事と同じディレクトリ（またはその近く）にある画像ファイルの一覧が表示されます。
    - **画像の追加**: 「Add
      Image」ボタンから画像をアップロードできます。アップロードした画像はドラフト（Pending）状態として扱われ、PR作成時にまとめてコミットされます。
    - **画像の挿入**:
      Markdownリンクで画像を挿入すると、リポジトリにまだコミットされていない画像でもマークダウンエディタ内に配置され、プレビューできます。
    - **プレビュー**: 一覧のファイル名をクリックすると画像をプレビューできます。
  - **History**: ファイルの過去のコミット履歴を確認できます。

**便利な機能:**

- **画像アップロード**:
  Markdownエディタ内に画像をドラッグ＆ドロップ（またはコピー＆ペースト）すると、自動的に画像がアップロードエリアに追加され、Markdownリンクが挿入されます。
- **ローカル自動保存**: 入力内容は即座に `localStorage`
  に保存されます。「Unsaved
  changes」ラベルが表示されている間は、ブラウザを閉じても内容は保持されます。
- **ドラフトリセット**: 「Reset
  Draft」ボタンでローカルの編集内容を破棄し、リモート（GitHub）の状態に戻すことができます。

### 4. 公開フロー (Pull Request)

1. 編集が完了したら、右ペインの **Description** に変更内容の説明を入力します。
2. **Create PR** ボタンをクリックします。
3. 自動的に新しいブランチが作成され、GitHub上でPull Requestがオープンされます。
4. エディタ画面に「PR
   Open」と表示され、PRへのリンクが表示されます。この状態ではローカルの編集はロックされます（PRとの不整合を防ぐため）。
5. GitHub上でマージされると、Webhookを通じてStaticmsにも反映され、再び編集が可能になります。変更が必要な場合はGitHub上でPRを閉じるか、マージを待ちます。

## インストール（管理者向け）

Staticmsを利用するには、対象のGitHubリポジトリにStaticms GitHub
Appをインストールする必要があります。

### 1. GitHub Appのインストールとリポジリの追加

1. Staticmsにアクセスし、ログインします。
2. リポジリ選択画面にある **Add missing repository**
   リンクなどをクリックし、GitHubのApp設定画面へ移動します。
3. インストール先のアカウントまたはOrganizationを選択します（既にインストール済みの場合は設定変更画面になります）。
4. **Only select repositories** を選択し、Staticmsで管理したいリポジリを選択して
   **Install** (または **Save**) をクリックします。

### 2. アンインストール（利用停止）

Staticmsの利用を停止したい場合は、GitHub上からAppをアンインストールします。

1. GitHubの **Settings** > **Applications** > **Installed GitHub Apps**
   にアクセスします。
2. Staticmsの **Configure** ボタンをクリックします。
3. ページ最下部の **Uninstall "Staticms"** 枠にある **Uninstall**
   ボタンをクリックします。

## 開発者向け情報

Staticms自体の開発や、自前のサーバーでのホスティングに興味がある方は、[DEVELOPMENT.md](./DEVELOPMENT.md)
を参照してください。 ローカル環境でのセットアップ方法や、独自のGitHub
Appの作成方法について詳しく解説しています。

## ライセンス

MIT License
