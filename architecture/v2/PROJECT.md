# Statcms

**Staticms** は、GitHubの自分のリポジトリをストレージとするヘッドレスCMSです。

## 1. 概要と位置づけ

本企画は、**GitHub App「Statcms」**
の概要を説明するものです。GitHubリポジトリをコンテンツの永続的な保存先とし、Static
Site Generator (SSG) との連携を前提とした、**ヘッドレスCMS**として機能します。

本Appは、GitHubの操作に不慣れなコンテンツ管理者に対し、構造化された直感的なWebインターフェース（UI）を提供し、**マークダウン（Markdown）**
および **YAML** 形式のコンテンツ編集を効率化します。

| 項目     | 詳細                                                |
| :------- | :-------------------------------------------------- |
| **名称** | **Statcms**                                         |
| **種別** | **GitHub App**                                      |
| **機能** | GitHubをコンテンツストレージとする**ヘッドレスCMS** |
| **前提** | **Static Site Generator (SSG)との連携**             |

---

## 2. 導入フェーズとリポジトリ管理

GitHub Appである **Statcms**
は、**リポジトリまたはオーガニゼーション**にインストールされます。

### 2.1. GitHub Appインストール導線と支援

1. **インストール導線の常時提供:**
   UIにログイン後、Appは**利用可能なリポジトリの有無にかかわらず**、常に**GitHubのAppランディングサイトへのリンク（導線）**
   を提供します。
2. **WebHook設定:**
   Appがリポジトリにインストールされた際、AppはGitHubの機能を通じてそのリポジトリに、**変更通知を受け取るためのWebHookを自動的に設定します**。
3. **アンインストール:**
   AppのUIはアンインストールに関する導線を提供しません。アンインストールはGitHubのリポジトリ管理画面で行われ、AppはWebHookでアンインストールを検知し、関連するメタデータを削除します。

### 2.2. リポジトリ選択画面の挙動

- **表示対象:**
  UIにログイン後、ユーザーがアクセスするリポジトリ選択画面では、**現在Statcmsが導入されているリポジトリ**の中から、ユーザーがアクセス権を持つものが一覧として列挙されます。

---

## 3. システム構成と認証認可

### 3.1. アプリケーションの構成

- **コンテンツ実体:**
  Markdown/YAMLファイルは**GitHubリポジトリ**に格納されます。
- **メタデータ管理:**
  コンテンツの一覧、ファイルごとのアーキタイプ定義などは、**リポジトリの外側にあるStatcmsが管理するデータベース**で保持されます。
- **WebHookの役割:**
  WebHookは、リポジトリのイベント（PRのマージ/クローズ、Appの削除など）の**通知を受け取るため**に利用されます。

### 3.2. ユーザー認証と認可

| 項目               | 詳細                                                                                                               | 認可主体              |
| :----------------- | :----------------------------------------------------------------------------------------------------------------- | :-------------------- |
| **ユーザー認証**   | UIへのアクセスは**GitHubのOAuth認証**を通じて行われます。                                                          | ユーザー              |
| **コンテンツ編集** | リポジトリ内のファイルの読み書き（コミット）は、UIを操作する**ユーザー自身のGitHubアカウントの認可**で行われます。 | ユーザー              |
| **その他操作**     | WebHookの処理（通知の受信）などは**Statcms自身の認可**で行われます。                                               | Statcms（GitHub App） |

---

## 4. コンテンツの構造とアーキタイプ

### 4.1. 対象ファイルと構造

| ファイル種類       | 構成要素                     | 構造タイプ                         |
| :----------------- | :--------------------------- | :--------------------------------- |
| **Markdown (.md)** | **フロントマター**と**本文** | Singleton / **Collection（記事）** |
| **YAML (.yml)**    | データ本体のみ（本文なし）   | Singleton のみ                     |

- **Collection（記事）:** 複数のサブコンテンツ（記事）を束ねるフォルダ構造です。

### 4.2. アーキタイプによるコンテンツ構造の定義

- **すべてのアーキタイプで定義するもの:**
  フロントマターの項目集合（編集フォームのテンプレート）。
- **Collection（記事）のアーキタイプにのみ定義可能なもの:**
  1. **フロントマターのデフォルト値**。
  2. **本文のテンプレート**。

---

## 5. コンテンツ編集時の状態管理

### 5.1. 編集中の自動保存（ドラフト）と画像ファイルの管理

- **自動保存の実施:**
  編集中の状態（コンテンツと新規画像ファイル）は、リポジトリへの反映前に**ブラウザのローカルストレージ**に**ドラフト**として**常に自動で保存**されます。
- **セッション持続:**
  次回同じコンテンツを開いた際に、この**ドラフト**が復元されます。

### 5.2. 明示的な保存操作とGitHubへの反映

- ユーザーがUI上で**明示的に「保存」操作**を行うと、ローカルの**ドラフト**内容を元に、すべての変更を包含した**プルリクエスト（PR）を発行**します。
- PR発行操作をもって、該当コンテンツは直ちに**ロック状態**へ移行します。

### 5.3. 編集ロックとPR状態の常時表示

- **ロック条件:**
  コンテンツに対して**オープン状態のPR**が一つでも存在する場合、そのコンテンツはロック状態となります。
- **UIの挙動（ロック中）:**
  1. コンテンツ編集画面には、**常にプルリクエストが存在することを示すメッセージ**が表示され、コンテンツ全体が**読み取り専用**（編集ロック状態）となります。
  2. メッセージには、オープン中のPRのリンクが表示されます。
- **ロックの解除とリセット:**
  PRの「マージ」または「クローズ」イベントをWebHookで受信した場合、コンテンツの**編集ロックを解除**し、**ローカルのドラフトを削除**後、リポジトリの最新内容を読み込み直します。

---

## 6. ユーザーインターフェース（UI）機能

### 6.1. 編集機能の詳細

| 形式         | 編集対象           | 機能の特徴                                                                                                                     |
| :----------- | :----------------- | :----------------------------------------------------------------------------------------------------------------------------- |
| **Markdown** | フロントマター     | アーキタイプに基づく**フォーム形式**での編集。                                                                                 |
| **Markdown** | 本文               | **マークダウン文法入力支援機能**を持つテキストエリア。                                                                         |
| **Markdown** | **画像管理**       | **実態ファイルがあるフォルダ内の画像**を一覧表示。UI操作で新規画像を追加できます。                                             |
| **Markdown** | **画像リンク挿入** | 一覧の画像をUI操作で選択し、**マークダウン本文に適切な画像リンクを自動で挿入**できます。                                       |
| **Markdown** | **プレビュー**     | 編集内容をHTML形式で確認。**画像はリポジトリ上とブラウザローカル（ドラフト）のどちらにあるかに関わらず、正しく表示されます**。 |
| **YAML**     | データ本体         | フォーム形式での編集。配列データもUI上で操作可能。**本文エリアは存在しません**。                                               |

---

## 7. 期待される効果

- **非エンジニアの貢献促進:** 直感的なUIで安全にコンテンツを更新できます。
- **競合の防止:**
  PRベースのワークフローと**編集ロック機能**により、複数人による編集やデータの矛盾を防ぎます。
- **SSG連携の効率化:**
  GitHubへのコミットがトリガーとなり、静的サイトのビルド・デプロイが自動的に実行される、効率的なワークフローを確立します。
