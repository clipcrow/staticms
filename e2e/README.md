# E2Eテストのベストプラクティス

このディレクトリには、DenoとAstralを使用して実装されたStaticmsのEnd-to-End (E2E)
テストが含まれています。

## ベストプラクティスと学んだ教訓

### 1. 要素だけでなく、安定性を待つ

`globalThis.location.href`
の変更などによるフルページリロードをテストする場合、URLをチェックする単純な
`waitForSelector` や `waitForFunction`
だけでは、新しいページのDOMが完全に構築または安定する前にパスしてしまうことがあります。

- **問題点**:
  HTMLダンプに要素が含まれていても、リロード中の実行コンテキストの消失などが原因で
  `waitForSelector` がタイムアウトしたりエラーになったりすることがあります。
- **解決策**: ナビゲーション/リロードを確認した後、明示的な `sleep` (例:
  `setTimeout`)
  を挟んで、ブラウザがドキュメントを完全に切り替え、新しいDOMが安定するのを確実に待ちます。

  ```typescript
  // URLの変化を待つ
  await page.waitForFunction(() => !location.search.includes("action="));
  // DOMの安定化を待つ（重要）
  await new Promise((r) => setTimeout(r, 2000));
  // その後、要素を確認する
  await page.waitForSelector(".collection-item");
  ```

### 2. リスト内での一意な Key の確保

Reactはリスト項目に一意な `key`
プロップを要求します。E2Eテストにおいて、バックエンドの状態が汚染されたり、ロジックのバグで同じ
`key`
を持つエントリが重複して生成されたりすると、Reactがリストを正しくレンダリングできなかったり、警告/エラーを出してテストセレクタの動作を妨げたりすることがあります。

- **解決策**:
  コンポーネントが真に一意なキーを使用するようにします（開発/テスト中に重複の可能性がある場合は
  `${id}-${index}` のような複合キーを使用するなど）。
- **検証**:
  テストでは、項目の存在だけでなく、その**数**をアサートすることが重要です。

### 3. Configオブジェクトのディープコピー

メモリ内で設定オブジェクトを変更する場合（APIに送信する前など）、そのオブジェクトが共有ソース（フックやグローバル状態など）から来ている場合は、必ずディープコピーを行ってください。シャローコピー
(`{ ...config }`)
ではネストされた配列やオブジェクトが共有されたままになり、元のオブジェクトがレンダリングや他のテストで再利用された場合に予期しない副作用を引き起こします。

- **解決策**:
  JSONシリアライズ可能な設定オブジェクトの場合、`JSON.parse(JSON.stringify(config))`
  がディープコピーを行うためのシンプルで効果的な方法です。

### 4. デバッグ手法

- **HTMLダンプ**: セレクタが見つからずに失敗した場合、エラーをキャッチして
  `document.body.innerHTML`
  をログに出力すると、ヘッドレスブラウザの状態を把握するのに非常に役立ちます。
- **コンソールログ**: `page.on("console", ...)`
  を使用してブラウザのコンソールログをDenoのターミナルにプロキシ出力することで、フロントエンドのエラーやロジックのトレースを確認できます。

## 技術スタックの評価

今回のE2Eテスト実装において採用した技術スタック（Deno +
Astral）の評価は以下の通りです。

### Astral (Headless Browser Automation)

- **長所**:
  - Denoネイティブであり、セットアップが非常に軽量で高速。`npm install`
    で重いPuppeteer/Playwrightのバイナリ管理をする必要がない。
  - Playwright互換に近いAPIを持っており、学習コストが低い。
  - テストランナーとシームレスに統合できる。
- **短所**:
  - `waitForNavigation` や `waitForFunction` の挙動が、ページのFull
    Refresh時においてPlaywrightほど堅牢ではない場合がある（今回の `sleep`
    対応が必要だった主因）。
  - エラーメッセージが簡素で、DOMの状態把握には工夫（HTMLダンプ等）が必要。

### Deno Test Runner

- **長所**:
  - 設定ゼロでTypeScriptを実行でき、高速。
  - `deno task` との統合が容易。
- **短所**:
  - 標準出力のバッファリングや並列実行時のログ出力制御など、大規模なE2Eテストスイートを扱うにはレポーティング機能がまだ最小限。

**総評**:
プロジェクトの規模やDenoエコシステムへの親和性を考えると、Astralは非常に有力な選択肢です。ただし、複雑なSPA遷移やFull
Page
Reloadを多用するフローにおいては、待機処理に防御的な実装（明示的なSleepやDOM安定化待ち）を組み込むことが安定稼働の鍵となります。
